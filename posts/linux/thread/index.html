<!DOCTYPE html>
<html><head><title>pthread가 뭔지 몰?루</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="../../../main.css" type="text/css"></head><body><header><a id="title" href="../../.."><h1>scarf@127.0.0.1</h1></a><nav><ul><li><a href="../../../about">About</a></li><li><a href="../..">Posts</a></li><li><a href="../../../tags">Tags</a></li></ul></nav><hr></header><section><content><article><h1><a href="">pthread가 뭔지 몰?루</a></h1><nav style="display:flex; height: 100%"><p>2022/01/15 21:18:46 Sat</p><a class="tag" href="../../../tags/linux">linux</a></nav><br><p></p><h3>참고자료</h3>
<p><a href="https://hpc-tutorials.llnl.gov/posix/">LLNL</a>
<a href="https://linux.die.net/man/3/pthread_create">man 3 pthread_*</a></p>
<h2>스레드가 모지</h2>
<table>
<thead>
<tr>
<th style="text-align:center">종류</th>
<th style="text-align:center">특징</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>프로그램</strong></td>
<td style="text-align:center">코드가 적힌 텍스트 파일</td>
</tr>
<tr>
<td style="text-align:center"><strong>프로세스</strong></td>
<td style="text-align:center">메모리에 올라가 실행중인 <em>프로그램</em></td>
</tr>
<tr>
<td style="text-align:center"><strong>스레드</strong></td>
<td style="text-align:center"><em>프로세스</em>에서 CPU가 처리중인 단위작업</td>
</tr>
</tbody>
</table>
<p>pthread는 <code>Posix thread library</code>의 약자
<a href="https://opensource.apple.com/source/libpthread/libpthread-301.30.1/pthread/pthread.h.auto.html">macos에서의 pthread.h</a></p>
<h2>3줄 요약</h2>
<ul>
<li>스레드 생성 &amp; 실행
<ul>
<li><a href="#pthread_create">pthread_create</a></li>
</ul>
</li>
<li>스레드 종료 후 자원 회수
<ul>
<li>스레드 끝날 때까지 기다린다면: <a href="#pthread_join">pthread_join</a></li>
<li>기다리지 않는다면: <a href="#pthread_detach">pthread_detach</a></li>
</ul>
</li>
</ul>
<p>스레드 생성과 자원 회수는 malloc과 free처럼 짝을 이루는 관계</p>
<h2>스레드 만들고 실행하기</h2>
<h3>pthread_create</h3>
<pre><code class="language-yaml hljs"><span class="hljs-attr">pthread:</span> <span class="hljs-string">스레드</span> <span class="hljs-string">id,</span> <span class="hljs-string">fd와</span> <span class="hljs-string">비슷하나</span> <span class="hljs-string">구현에</span> <span class="hljs-string">따라</span> <span class="hljs-string">정수형이</span> <span class="hljs-string">아니라</span> <span class="hljs-string">구조체일</span> <span class="hljs-string">수</span> <span class="hljs-string">있음</span>
<span class="hljs-attr">attr:</span> <span class="hljs-string">스레드</span> <span class="hljs-string">세부</span> <span class="hljs-string">속성</span>
  <span class="hljs-attr">NULL:</span> <span class="hljs-string">기본값</span>
<span class="hljs-attr">start_routine:</span> <span class="hljs-string">실행할</span> <span class="hljs-string">함수</span>
<span class="hljs-attr">arg:</span> <span class="hljs-string">`start_routine`에</span> <span class="hljs-string">들어갈</span> <span class="hljs-string">인수</span>
</code></pre>
<ul>
<li>새로운 자식 스레드를 생성하고 실행</li>
<li>자식 스레드가 끝나기까지 기다리지 <strong>않음</strong></li>
<li>생성된 스레드는 <strong>종료되어도 자원(메모리) 반납을 하지 않음</strong></li>
</ul>
<h3>예시</h3>
<pre><code class="language-c hljs"><span class="hljs-comment">// 공통 코드</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> *(*routine)(<span class="hljs-type">void</span> *);

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">s_data</span> {</span>
	<span class="hljs-type">int</span> a;
} data;

<span class="hljs-type">void</span> *<span class="hljs-title function_">thread_func</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span>
{
	<span class="hljs-keyword">const</span> data *val = arg;

	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"[스레드] 인자 %d로 실행된 함수\n"</span>,val-&gt;a);
	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
</code></pre>
<h4>그냥 실행했을 시</h4>
<pre><code class="language-c hljs"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
	<span class="hljs-type">pthread_t</span> thread;

	pthread_create(&amp;thread, <span class="hljs-literal">NULL</span>, thread_func, &amp;((data){<span class="hljs-number">123</span>}));
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
<span class="hljs-comment">/* 출력 없이 종료 */</span>
</code></pre>
<h4>main문에서 무한루프로 기다릴 시</h4>
<pre><code class="language-c hljs"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
	<span class="hljs-type">pthread_t</span> thread;

	pthread_create(&amp;thread, <span class="hljs-literal">NULL</span>, thread_func, &amp;((data){<span class="hljs-number">123</span>}));
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"[main] 기다리는 중\n"</span>);
	<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {};
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
<span class="hljs-comment">/*
[main] 기다리는 중
[스레드] 인자 123로 실행된 함수
*/</span>
</code></pre>
<h2>스레드 종료 후 자원 회수하기</h2>
<h3>pthread_join / pthread_detach를 쓰는 이유는?</h3>
<h4>사용 안할 시</h4>
<pre><code class="language-yaml hljs"><span class="hljs-string">❯</span> <span class="hljs-string">valgrind</span> <span class="hljs-string">--leak-check=full</span> <span class="hljs-string">--show-leak-kinds=all</span> <span class="hljs-string">./learn_pthread</span>

<span class="hljs-attr">HEAP SUMMARY:</span>
    <span class="hljs-attr">in use at exit:</span> <span class="hljs-number">272</span> <span class="hljs-string">bytes</span> <span class="hljs-string">in</span> <span class="hljs-number">1</span> <span class="hljs-string">blocks</span>
  <span class="hljs-attr">total heap usage:</span> <span class="hljs-number">2</span> <span class="hljs-string">allocs,</span> <span class="hljs-number">1</span> <span class="hljs-string">frees,</span> <span class="hljs-number">4</span><span class="hljs-string">,368</span> <span class="hljs-string">bytes</span> <span class="hljs-string">allocated</span>

<span class="hljs-number">272</span> <span class="hljs-string">bytes</span> <span class="hljs-string">in</span> <span class="hljs-number">1</span> <span class="hljs-string">blocks</span> <span class="hljs-string">are</span> <span class="hljs-string">possibly</span> <span class="hljs-string">lost</span> <span class="hljs-string">in</span> <span class="hljs-string">loss</span> <span class="hljs-string">record</span> <span class="hljs-number">1</span> <span class="hljs-string">of</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">by 0x49075D9:</span> <span class="hljs-string">pthread_create@@GLIBC_2.34</span> <span class="hljs-string">(pthread_create.c:623)</span>
  <span class="hljs-attr">by 0x1091F9:</span> <span class="hljs-string">init_pthread</span> <span class="hljs-string">(in</span> <span class="hljs-string">/home/scarf/Repo/learn_pthread/learn_pthread)</span>

<span class="hljs-attr">LEAK SUMMARY:</span>
  <span class="hljs-attr">possibly lost:</span> <span class="hljs-number">272</span> <span class="hljs-string">bytes</span> <span class="hljs-string">in</span> <span class="hljs-number">1</span> <span class="hljs-string">blocks</span>
<span class="hljs-attr">ERROR SUMMARY:</span>
  <span class="hljs-number">1</span> <span class="hljs-string">errors</span> <span class="hljs-string">from</span> <span class="hljs-number">1</span> <span class="hljs-string">contexts</span> <span class="hljs-string">(suppressed:</span> <span class="hljs-number">0</span> <span class="hljs-string">from</span> <span class="hljs-number">0</span><span class="hljs-string">)</span>
</code></pre>
<p>메모리 누수 발생</p>
<h4>사용 시</h4>
<pre><code class="language-yaml hljs"><span class="hljs-attr">HEAP SUMMARY:</span>
    <span class="hljs-attr">in use at exit:</span> <span class="hljs-number">0</span> <span class="hljs-string">bytes</span> <span class="hljs-string">in</span> <span class="hljs-number">0</span> <span class="hljs-string">blocks</span>
  <span class="hljs-attr">total heap usage:</span> <span class="hljs-number">2</span> <span class="hljs-string">allocs,</span> <span class="hljs-number">2</span> <span class="hljs-string">frees,</span> <span class="hljs-number">4</span><span class="hljs-string">,368</span> <span class="hljs-string">bytes</span> <span class="hljs-string">allocated</span>
<span class="hljs-string">All</span> <span class="hljs-string">heap</span> <span class="hljs-string">blocks</span> <span class="hljs-string">were</span> <span class="hljs-string">freed</span> <span class="hljs-string">--</span> <span class="hljs-literal">no</span> <span class="hljs-string">leaks</span> <span class="hljs-string">are</span> <span class="hljs-string">possible</span>
<span class="hljs-attr">ERROR SUMMARY:</span> <span class="hljs-number">0</span> <span class="hljs-string">errors</span> <span class="hljs-string">from</span> <span class="hljs-number">0</span> <span class="hljs-string">contexts</span> <span class="hljs-string">(suppressed:</span> <span class="hljs-number">0</span> <span class="hljs-string">from</span> <span class="hljs-number">0</span><span class="hljs-string">)</span>
</code></pre>
<p>스레드 종료 후 자원이 반환(free)됨</p>
<h3>pthread_join</h3>
<pre><code class="language-yaml hljs"><span class="hljs-attr">pthread:</span> <span class="hljs-string">합칠</span> <span class="hljs-string">스레드</span>
<span class="hljs-attr">retval:</span> <span class="hljs-string">받아올</span> <span class="hljs-string">반환값</span>
</code></pre>
<ul>
<li>인자로 준 스레드가 종료할 때까지 대기</li>
<li>종료된 스레드의 자원 회수</li>
</ul>
<h3>pthread_detach</h3>
<pre><code class="language-yaml hljs"><span class="hljs-attr">pthread:</span> <span class="hljs-string">detach할</span> <span class="hljs-string">스레드</span>
</code></pre>
<ul>
<li>인자로 준 스레드를 <strong>detach</strong>상태로 만듬</li>
<li><strong>detached</strong>된 스레드는
<ul>
<li>종료 시 자동으로 자원이 반환됨</li>
<li>다시 join이 불가능</li>
</ul>
</li>
</ul>
<h2>순서도</h2>
<pre><code class="language-c hljs">메인 스레드
    |
    V
<span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span>
    |
    V
<span class="hljs-comment">// 스레드 생성 및 실행</span>
<span class="hljs-title function_">pthread_create</span><span class="hljs-params">(pthread, attr, start_routine, arg)</span>
    |               |
    V               V
이후 코드 실행...  자식 스레드
    |           <span class="hljs-params">(pthread, attr, start_routine, arg)</span>
    |               |
    |               V
    |           <span class="hljs-title function_">start_routine</span><span class="hljs-params">(arg)</span> 실행...
    |               |
    |               V
    |              종료
    |               /
    V              V
<span class="hljs-comment">// 스레드가 끝날 때까지 대기</span>
<span class="hljs-title function_">pthread_join</span><span class="hljs-params">(pthread)</span>
    |
    V
<span class="hljs-title function_">return</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span>;
</code></pre>
<p></p></article><hr><script src="https://utteranc.es/client.js" repo="scarf005/comments" issue-term="pathname" label="comment" theme="github-dark" crossorigin="anonymous" async=""></script></content></section><footer></footer><link rel="stylesheet" href="../../../fonts.css" type="text/css"></body></html>